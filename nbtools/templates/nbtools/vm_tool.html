
{% extends 'base/layout.html' %}
{% block header %}
<h1>VM Tool</h1>
{% endblock header %}
{% block content %}
<div class="container">

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">{{ message|safe }}</div>
        {% endfor %}
    {% endif %}

    {% if mode == "initial" %}
        <p>This plugin will help you create a new VM or assign IP to an existing VM.</p>
        <form method="post">
            {% csrf_token %}
            <button type="submit" name="action" value="new_vm" class="btn btn-primary">New VM</button>
            <button type="submit" name="action" value="existing_vm" class="btn btn-secondary">Existing VM</button>
        </form>
    {% endif %}

    {% if mode == "new_vm" %}
        <h4>Create New VM</h4>
        <form method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="create_vm">
            <!-- Fields -->
            <div class="mb-3"><label>Name*</label><input type="text" name="name" class="form-control" value="{{ name|default:'' }}" required></div>
            <div class="mb-3"><label>Role</label><select name="role" class="form-select">{% for role in roles %}<option value="{{ role.id }}">{{ role.name }}</option>{% endfor %}</select></div>
            <div class="mb-3"><label>Description</label><textarea name="description" class="form-control">{{ description|default:'' }}</textarea></div>
            <div class="mb-3"><label>Site</label><select name="site" class="form-select">{% for site in sites %}<option value="{{ site.id }}">{{ site.name }}</option>{% endfor %}</select></div>
            <div class="mb-3"><label>Cluster</label><select name="cluster" class="form-select">{% for cluster in clusters %}<option value="{{ cluster.id }}">{{ cluster.name }}</option>{% endfor %}</select></div>
            <button type="submit" class="btn btn-success">Create</button>
            <button type="submit" name="action" value="cancel" class="btn btn-secondary">Cancel</button>
        </form>
    {% endif %}

    {% if mode == "existing_vm" %}
        <h4>Modify Existing VM</h4>
        <form method="post" id="existing-vm-form">
            {% csrf_token %}
            <input type="hidden" name="action" value="apply_changes">
            <div class="mb-3"><label>Virtual Machine</label><select id="vm" name="vm" class="form-select"><option value="">Select VM</option>{% for vm in vms %}<option value="{{ vm.id }}">{{ vm.name }}</option>{% endfor %}</select></div>
            <div class="mb-3"><label>Network Interface</label><select id="interface" name="interface" class="form-select"><option value="">Select Interface</option></select></div>
            <div class="mb-3"><label>IP Prefix</label><select id="prefix" name="prefix" class="form-select"><option value="">Select Prefix</option>{% for prefix in prefixes %}<option value="{{ prefix.id }}">{{ prefix.prefix }}</option>{% endfor %}</select></div>
            <div class="form-check mb-3"><input class="form-check-input" type="checkbox" id="auto_ip" name="auto_ip"><label class="form-check-label">Pick next available IP</label></div>
            <div class="mb-3"><label>Primary IP (x.x.x.x)</label><input type="text" id="ip_address" name="ip_address" class="form-control"></div>
            <button type="submit" id="apply-btn" class="btn btn-success" disabled>Make Changes</button>
            <button type="submit" name="action" value="cancel" class="btn btn-secondary">Cancel</button>
        </form>
    {% endif %}
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const vmSelect = document.getElementById("vm");
    const interfaceSelect = document.getElementById("interface");
    const applyBtn = document.getElementById("apply-btn");
    const ipInput = document.getElementById("ip_address");
    const prefixSelect = document.getElementById("prefix");
    const autoIpCheckbox = document.getElementById("auto_ip");

    function toggleApplyButton() {
        const vmFilled = vmSelect.value;
        const ifaceFilled = interfaceSelect.value;
        const prefixFilled = prefixSelect.value;
        const ipFilled = autoIpCheckbox.checked || ipInput.value.trim() !== "";
        applyBtn.disabled = !(vmFilled && ifaceFilled && prefixFilled && ipFilled);
    }

    vmSelect.addEventListener("change", function () {
        const vmId = vmSelect.value;
        interfaceSelect.innerHTML = '<option value="">Loading...</option>';
        if (vmId) {
            fetch(`/api/virtualization/interfaces/?virtual_machine=${vmId}`)
                .then(response => response.json())
                .then(data => {
                    interfaceSelect.innerHTML = '';
                    if (data.results.length > 0) {
                        data.results.forEach(iface => {
                            const option = document.createElement("option");
                            option.value = iface.id;
                            option.textContent = iface.name;
                            interfaceSelect.appendChild(option);
                        });
                    } else {
                        const option = document.createElement("option");
                        option.value = "new";
                        option.textContent = "Create a new Interface";
                        interfaceSelect.appendChild(option);
                    }
                    toggleApplyButton(); // Recheck after update
                });
        } else {
            interfaceSelect.innerHTML = '<option value="">Select Interface</option>';
            toggleApplyButton();
        }
    });

    autoIpCheckbox.addEventListener("change", function () {
        ipInput.disabled = autoIpCheckbox.checked;
        toggleApplyButton();
    });

    prefixSelect.addEventListener("change", toggleApplyButton);
    ipInput.addEventListener("input", toggleApplyButton);
});
</script>
{% endblock content %}
