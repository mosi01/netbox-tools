{% extends 'base/layout.html' %}
{% block header %}
<h1>VM Tool</h1>
{% endblock header %}
{% block content %}
<div class="container">

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">{{ message|safe }}</div>
        {% endfor %}
    {% endif %}

    {% if mode == "initial" %}
        <p>This plugin will help you create a new VM or assign IP to an existing VM.</p>
        <form method="post">
            {% csrf_token %}
            <button type="submit" name="action" value="new_vm" class="btn btn-primary">New VM</button>
            <button type="submit" name="action" value="existing_vm" class="btn btn-secondary">Existing VM</button>
        </form>
    {% endif %}

    {% if mode == "new_vm" %}
        <!-- New VM Form -->
        <h4>Create New VM</h4>
        <form method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="create_vm">
            <!-- Fields -->
            <div class="mb-3"><label>Name*</label><input type="text" name="name" class="form-control" value="{{ name|default:'' }}" required></div>
            <div class="mb-3"><label>Role</label><select name="role" class="form-select">{% for role in roles %}<option value="{{ role.id }}">{{ role.name }}</option>{% endfor %}</select></div>
            <div class="mb-3"><label>Description</label><textarea name="description" class="form-control">{{ description|default:'' }}</textarea></div>
            <div class="mb-3"><label>Site</label><select name="site" class="form-select">{% for site in sites %}<option value="{{ site.id }}">{{ site.name }}</option>{% endfor %}</select></div>
            <div class="mb-3"><label>Cluster</label><select name="cluster" class="form-select">{% for cluster in clusters %}<option value="{{ cluster.id }}">{{ cluster.name }}</option>{% endfor %}</select></div>
            <button type="submit" class="btn btn-success">Create</button>
            <button type="submit" name="action" value="cancel" class="btn btn-secondary">Cancel</button>
        </form>
    {% endif %}

    {% if mode == "existing_vm" %}
        <!-- Existing VM Form -->
        <h4>Modify Existing VM</h4>
        <form method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="apply_changes">

            <!-- VM Dropdown -->
            <div class="mb-3">
                <label>Virtual Machine</label>
                <select name="vm" id="vm" class="form-select" onchange="this.form.submit()">
                    <option value="">Select VM</option>
                    {% for vm in vms %}
                        <option value="{{ vm.id }}" {% if vm.id|stringformat:"s" == selected_vm %}selected{% endif %}>{{ vm.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Interface Dropdown -->
            <div class="mb-3">
                <label>Network Interface</label>
                <select name="interface" id="interface" class="form-select" {% if not interfaces %}disabled{% endif %}>
                    {% if interfaces %}
                        {% for iface in interfaces %}
                            <option value="{{ iface.id }}" {% if iface.id|stringformat:"s" == selected_interface %}selected{% endif %}>{{ iface.name }}</option>
                        {% endfor %}
                    {% else %}
                        <option value="new">Create a new Interface</option>
                    {% endif %}
                </select>
            </div>

            <!-- Prefix Dropdown -->
            <div class="mb-3">
                <label>IP Prefix</label>
                <select name="prefix" id="prefix" class="form-select">
                    <option value="">Select Prefix</option>
                    {% for prefix in prefixes %}
                        <option value="{{ prefix.id }}" {% if prefix.id|stringformat:"s" == selected_prefix %}selected{% endif %}>{{ prefix.prefix }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Auto IP Checkbox -->
            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="auto_ip" name="auto_ip" {% if auto_ip %}checked{% endif %}>
                <label class="form-check-label">Pick next available IP</label>
            </div>

            <!-- Primary IP -->
            <div class="mb-3">
                <label>Primary IP (x.x.x.x)</label>
                <input type="text" id="ip_address" name="ip_address" class="form-control" value="{{ ip_address|default:'' }}" {% if auto_ip %}disabled{% endif %}>
            </div>

            <button type="submit" class="btn btn-success">Make Changes</button>
            <button type="submit" name="action" value="cancel" class="btn btn-secondary">Cancel</button>
        </form>
    {% endif %}
</div>
{% endblock content %}
