{% extends 'base/layout.html' %}
{% load static %}

{% block header %}
<h1>Documentation Reviewer</h1>
{% endblock header %}

{% block content %}
<div id="alert-wrapper">
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} mt-3 mx-3">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}
  {% if message %}
    <div class="alert alert-warning mx-3">
      {{ message }}
    </div>
  {% endif %}
  {% if reviewed_ids %}
    <div class="alert alert-info mx-3">
      Reviewed IDs received: {{ reviewed_ids|join:", " }}
    </div>
  {% endif %}
</div>

<div class="container">
  <p>Below are Devices and Virtual Machines with missing or outdated documentation.</p>

  <!-- Search and action form -->
  <form method="post">
    {% csrf_token %}
    <div class="form-group">
      <input type="text" name="search" class="form-control" placeholder="Search by name..." value="{{ search_query }}" autocomplete="off">
    </div>
    <div class="form-group">
      <input type="hidden" name="action" value="check_fields">
      <button type="submit" class="btn btn-primary">Check Fields</button>
      <button type="submit" name="action" value="update_fields" class="btn btn-primary">Update Fields</button>
    </div>
  </form>

  {% if flagged_objects %}
    <!-- Review form -->
    <form method="post" id="review-form">
      {% csrf_token %}
      <input type="hidden" name="action" value="mark_reviewed">
      <input type="hidden" name="selected_count" id="selected-count-field">
      <table class="table table-hover mt-3">
        <thead>
          <tr>
            <th><input type="checkbox" id="check-all"></th>
            <th>Name</th>
            <th>Type</th>
            <th>Latest Update</th>
            <th>Reviewed</th>
          </tr>
        </thead>
        <tbody>
          {% for obj in flagged_objects %}
          <tr>
            <td><input type="checkbox" name="reviewed_ids" value="{{ obj.id }}"></td>
            <td><a href="{{ obj.url }}" target="_blank">{{ obj.name }}</a></td>
            <td>{{ obj.type }}</td>
            <td>{{ obj.latest_update|default_if_none:"Not available" }}</td>
            <td>{% if obj.reviewed %}Yes{% else %}No{% endif %}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </form>

    <!-- Floating Save Button -->
    <div id="floating-save-container">
      <span id="selected-count">Selected: 0</span>
      <button type="submit" form="review-form" class="btn btn-success" id="save-button">
        <span id="save-text">Save Reviewed</span>
        <span id="spinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
      </button>
    </div>
  {% else %}
    <p>All documentation is up to date and reviewed.</p>
  {% endif %}
</div>

<style>
  body {
    margin-bottom: 80px;
  }

  #alert-wrapper {
    position: relative;
    z-index: 10000;
  }

  #floating-save-container {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background-color: var(--bs-body-bg);
    padding: 12px 20px;
    border-top: 1px solid var(--bs-border-color);
    box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.05);
    z-index: 9999;
    display: flex;
    justify-content: flex-end;
    align-items: center;
    gap: 10px;
  }

  #floating-save-container.hidden {
    display: none;
  }

  #selected-count {
    font-weight: 500;
    color: var(--bs-secondary-color);
  }

  #save-button {
    min-width: 150px;
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const checkAll = document.getElementById("check-all");
    const checkboxes = document.querySelectorAll('input[name="reviewed_ids"]');
    const selectedCount = document.getElementById("selected-count");
    const saveButton = document.getElementById("save-button");
    const spinner = document.getElementById("spinner");
    const saveText = document.getElementById("save-text");
    const floatingContainer = document.getElementById("floating-save-container");
    const selectedCountField = document.getElementById("selected-count-field");

    function updateCounter() {
      const count = Array.from(checkboxes).filter(cb => cb.checked).length;
      selectedCount.textContent = `Selected: ${count}`;
      selectedCountField.value = count;
    }

    function toggleFloatingVisibility() {
      const table = document.querySelector("table");
      if (!table) return;

      const rect = table.getBoundingClientRect();
      const bottomVisible = rect.bottom <= window.innerHeight;

      floatingContainer.classList.toggle("hidden", bottomVisible);
    }

    checkboxes.forEach(cb => cb.addEventListener("change", updateCounter));
    checkAll.addEventListener("change", () => {
      checkboxes.forEach(cb => cb.checked = checkAll.checked);
      updateCounter();
    });

    saveButton.addEventListener("click", () => {
      spinner.classList.remove("d-none");
      saveText.textContent = "Saving...";
    });

    updateCounter();
    toggleFloatingVisibility();
    window.addEventListener("scroll", toggleFloatingVisibility);
    window.addEventListener("resize", toggleFloatingVisibility);
  });
</script>
{% endblock content %}
