{% extends 'base/layout.html' %}
{% block header %}
<h1>Documentation Binding</h1>
{% endblock header %}
{% block content %}
<div class="container">

    <!-- Display Django messages -->
    {% if messages %}
    <div>
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Configuration Form -->
    <form method="post" action="{% url 'plugins:nbtools:documentation_binding' %}" class="mb-4">
        {% csrf_token %}
        <input type="hidden" name="action" value="save_config">
        <div class="mb-3">
            <label class="form-label">SharePoint Site URL:</label>
            <input type="text" name="site_url" class="form-control" value="{{ config.site_url }}">
        </div>
        <div class="mb-3">
            <label class="form-label">Directory (Tenant) ID:</label>
            <input type="text" name="application_id" class="form-control" value="{{ config.application_id }}">
        </div>
        <div class="mb-3">
            <label class="form-label">Application (Client) ID:</label>
            <input type="text" name="client_id" class="form-control" value="{{ config.client_id }}">
        </div>
        <div class="mb-3">
            <label class="form-label">Client Secret:</label>
            <input type="password" name="client_secret" class="form-control" value="{{ config.client_secret }}">
        </div>

        <!-- Dynamic Folder Mappings -->
        <div class="mb-3">
            <label class="form-label">Folder Mappings:</label>
            <div id="folder-mappings-container">
                {% for key, value in config.folder_mappings|default:{}|dictsort %}
                <div class="d-flex mb-2">
                    <input type="text" name="folder_keys[]" class="form-control me-2" value="{{ key }}" placeholder="Key">
                    <input type="text" name="folder_values[]" class="form-control" value="{{ value }}" placeholder="Path">
                </div>
                {% endfor %}
            </div>
            <button type="button" class="btn btn-secondary btn-sm" onclick="addFolderMapping()">Add More</button>
        </div>

        <!-- File Type Mappings -->
        <div class="mb-3">
            <label class="form-label">File Type Mappings (JSON):</label>
            <textarea name="file_type_mappings" class="form-control" rows="4">{{ config.file_type_mappings|default:'{".docx": "Word Document", ".vsdx": "Visio Drawing", ".xlsx": "Excel Spreadsheet"}' }}</textarea>
        </div>

        <button type="submit" class="btn btn-primary">Save Configuration</button>
    </form>

    <!-- Sync Button -->
    <form method="post" action="{% url 'plugins:nbtools:documentation_binding' %}" class="mb-4">
        {% csrf_token %}
        <input type="hidden" name="action" value="sync">
        <button type="submit" class="btn btn-success">Sync from SharePoint</button>
    </form>

    <!-- Cached Documents Table -->
    <div class="panel panel-default">
        <div class="panel-heading"><strong>Cached Documents</strong></div>
        <div class="panel-body" style="max-height: 400px; overflow-y: auto;">
            <table class="table table-hover table-striped">
                <thead>
                    <tr>
                        <th>Server</th>
                        <th>Filename</th>
                        <th>Version</th>
                        <th>File Type</th>
                        <th>Type</th>
                        <th>Category</th>
                        <th>Exists</th>
                    </tr>
                </thead>
                <tbody>
                    {% for doc in docs %}
                    <tr>
                        <td>
                            {% if doc.server_name %}
                                <a href="{% url 'virtualization:virtualmachine' doc.server_name %}">{{ doc.server_name }}</a>
                            {% else %}
                                N/A
                            {% endif %}
                        </td>
                        <td><a href="{{ doc.sharepoint_url }}" target="_blank">{{ doc.file_name }}</a></td>
                        <td>{{ doc.version }}</td>
                        <td>{{ doc.file_type }}</td>
                        <td>{{ doc.application_name|default:"Empty" }}</td>
                        <td>{{ doc.category }}</td>
                        <td>{{ doc.exists_flag|yesno:"True,False" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
function addFolderMapping() {
    const container = document.getElementById('folder-mappings-container');
    const div = document.createElement('div');
    div.className = 'd-flex mb-2';
    div.innerHTML = `
        <input type="text" name="folder_keys[]" class="form-control me-2" placeholder="Key">
        <input type="text" name="folder_values[]" class="form-control" placeholder="Path">
    `;
    container.appendChild(div);
}
</script>
{% endblock content %}
